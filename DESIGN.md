# **搜书神器 V2 \- 技术设计文档**

## **1\. 项目概述**

基于 Telegram 的高性能电子书搜索与管理机器人。

**目标**: 在非 Docker 环境下，精准复刻 docs/screenshots/ 中的 UI 和功能。

## **2\. 界面交互规范 (UI Specs)**

### **2.1 搜索结果列表 (/s 关键词)**

**参考**: image\_a3e500.jpg

* **信息头**: 🔍 {关键词} \> Results 1-10 of {总数} (用时 {耗时}s)  
* **列表项格式**:  
  {序号}. {书名} {Flag(🔞/🛡️)}  
  \[Emoji\] • {格式} • {大小} • {字数} • {评分}  
* **底部键盘**:  
  * 行1: \[1✅\] \[2\] \[3\] ... (动态翻页)  
  * 行2: \[分级\] \[格式\] \[体积\] \[字数\] (筛选)  
  * 行3: \[热度\] \[最新\] \[最大\] (排序)

### **2.2 书籍详情页**

**参考**: image\_a3e524.jpg

* **布局**:  
  * 封面图 (Optional)  
  * 文本块: 包含 书名(链接), 文件名, 统计(热度/下载/点赞), 评分(双评分制), **标签云(\#Tag)**, 简介。  
* **按钮矩阵**:  
  * \[收藏\] \[书单\] \[评论\]  
  * \[加标签\] \[找相似\] \[更多\]  
  * \[⬇️ 下载本书\] (核心功能)

### **2.3 上传交互**

**参考**: image\_a446bd.jpg

* **流程**:  
  1. 用户发送文件 \-\> Bot 回复 ⏳ 加入队列  
  2. 后台分析中 \-\> 编辑消息 ⚙️ 分析内容...  
  3. 完成 \-\> 编辑消息 ✅ 收录成功 并显示书籍链接。

## **3\. 系统架构 (Local Deployment)**

### **3.1 基础设施 (本地直连)**

* **数据库**: PostgreSQL (localhost:5432), 库名 bookbot。  
* **缓存**: Redis (localhost:6379), DB 0。  
* **搜索**: Meilisearch (localhost:7700), Key 在 .env 配置。

### **3.2 部署架构**

* **管理脚本**: 需要一个 manage.sh 脚本来屏蔽复杂的启动命令。  
* **进程管理**: 生产环境使用 Systemd (由脚本生成 .service 文件)。

### **3.3 核心逻辑**

* **文件去重**: 基于 SHA256。  
* **多重备份**: 文件入库后，自动转发至 BACKUP\_CHANNEL\_ID，并记录新的 File ID。  
* **混合打标**: 正则匹配文件名 \+ 文本前 50KB 关键词扫描。

## **4\. 数据模型**

* User: id, coins, level, is\_vip  
* Book: id, title, author, description, rating  
* File: hash (PK), size, extension, word\_count  
* FileRef: file\_hash, tg\_file\_id, channel\_id  
* Tag: id, name, category (e.g., "校花", "系统流")