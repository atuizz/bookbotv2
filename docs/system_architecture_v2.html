<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æœä¹¦ç¥å™¨ V2 - æ¶æ„å…¨æ™¯å›¾ (Arqç‰ˆ)</title>
    <!-- ä½¿ç”¨æœ€æ–°çš„ v11 ç‰ˆæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f6f8; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 1200px; margin: 0 auto; }
        h2 { border-bottom: 3px solid #0088cc; padding-bottom: 15px; color: #333; }
        .tips { background: #e3f2fd; padding: 10px; border-radius: 5px; color: #0d47a1; font-size: 0.9em; margin-bottom: 20px; }
        .legend { margin-top: 20px; font-size: 0.85em; color: #666; border-top: 1px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>æœä¹¦ç¥å™¨ V2 - ç³»ç»Ÿé€»è¾‘æ¶æ„å›¾ (å«è§„åˆ’)</h2>
        <div class="tips">ğŸ’¡ æç¤ºï¼šå®çº¿è¡¨ç¤ºå·²å®ç°åŠŸèƒ½ï¼Œè™šçº¿/ç°è‰²èŠ‚ç‚¹è¡¨ç¤ºè§„åˆ’ä¸­(Phase 3)åŠŸèƒ½ã€‚</div>
        
        <div class="mermaid">
            flowchart TD
                %% èŠ‚ç‚¹å®šä¹‰
                User(("ç”¨æˆ· (User)"))
                Admin(("ç®¡ç†å‘˜ (Admin)"))

                subgraph Core_Services ["æ ¸å¿ƒæœåŠ¡é›†ç¾¤"]
                    direction TB
                    TG_API["Telegram Bot API"]
                    Bot["Bot Core (Aiogram 3.x)"]
                    Arq["Arq å¼‚æ­¥ Worker"]
                    
                    %% å¾…å¼€å‘æ ¸å¿ƒæ¨¡å—
                    AdvDownload["ä¸‹è½½å¤„ç†å™¨ (ä¼˜åŒ–ç‰ˆ)"]
                    I18n["å¤šè¯­è¨€æ”¯æŒ (i18n)"]
                end
                
                subgraph Future_System ["æ‰©å±•ç®¡ç†ç³»ç»Ÿ (Phase 3)"]
                    direction TB
                    WebAdmin["Web ç®¡ç†åå° (FastAPI)"]
                    Stats["æ•°æ®ç»Ÿè®¡æŠ¥è¡¨"]
                    Docker["Docker å®¹å™¨åŒ–"]
                end

                subgraph Data_Layer ["æ•°æ®æŒä¹…å±‚"]
                    direction TB
                    Redis[("Redis ç¼“å­˜/æ¶ˆæ¯é˜Ÿåˆ—")]
                    PG[("PostgreSQL æ•°æ®åº“")]
                    Meili[("Meilisearch æœç´¢å¼•æ“")]
                end

                subgraph Backup_System ["å¤‡ä»½ä¸å­˜å‚¨"]
                    direction TB
                    BackupChannel["ç§æœ‰å¤‡ä»½é¢‘é“"]
                    S3["S3 å¯¹è±¡å­˜å‚¨ (é¢„ç•™)"]
                end

                %% äº¤äº’è¿çº¿
                User -->|"1.æœç´¢æŒ‡ä»¤ /s, /ss"| TG_API
                User -->|"2.ä¸Šä¼ æ–‡ä»¶"| TG_API
                TG_API <-->|"Webhook/Polling"| Bot
                
                %% Admin
                Admin -.->|"ç®¡ç†æŒ‡ä»¤"| Bot
                Admin -.->|"Web è®¿é—®"| WebAdmin

                %% å†…éƒ¨æ•°æ®æµ - Botç›´æ¥äº¤äº’
                Bot -->|"è¯»å†™ç¼“å­˜"| Redis
                Bot -->|"å…¨æ–‡æ£€ç´¢"| Meili
                Bot -->|"å…ƒæ•°æ®è¯»å†™"| PG
                Bot -.->|"ä¸‹è½½æµç¨‹"| AdvDownload
                Bot -.->|"è¯­è¨€é€‚é…"| I18n
                
                %% æ‰©å±•ç³»ç»Ÿæµ
                WebAdmin -.->|"ç®¡ç†æ•°æ®"| PG
                WebAdmin -.->|"ç›‘æ§çŠ¶æ€"| Redis
                Stats -.->|"åˆ†ææ•°æ®"| PG
                
                %% å¼‚æ­¥ä»»åŠ¡æµ
                Bot -->|"3.æ–‡ä»¶å…¥é˜Ÿ (arq)"| Redis
                Redis -->|"æ¶ˆè´¹ä»»åŠ¡"| Arq

                %% Worker å¤„ç†æµ
                Arq -->|"4.å»é‡ (SHA256)"| PG
                Arq -->|"5.æ··åˆæ‰“æ ‡/ç´¢å¼•"| Meili
                Arq -->|"6.è½¬å‘å¤‡ä»½"| BackupChannel
                Arq -->|"7.å®Œæˆé€šçŸ¥"| TG_API
                
                %% å¤‡ä»½æµ
                BackupChannel -.->|"è®°å½• File_ID"| Arq
                BackupChannel -.->|"å†·å¤‡ä»½"| S3

                %% æ ·å¼å®šä¹‰
                classDef blue fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
                classDef green fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
                classDef orange fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;
                classDef future fill:#f5f5f5,stroke:#9e9e9e,stroke-width:2px,stroke-dasharray: 5 5,color:#999;

                class Bot,TG_API blue;
                class PG,Meili,Redis green;
                class Arq orange;
                class S3,WebAdmin,Stats,Docker,AdvDownload,I18n future;
        </div>

        <div class="legend">
            <strong>å›¾ä¾‹è¯´æ˜ï¼š</strong><br>
            ğŸ”µ è“è‰²èŠ‚ç‚¹ï¼šæ ¸å¿ƒæœåŠ¡ä¸æ¥å£ (å·²ä¸Šçº¿)<br>
            ğŸŸ¢ ç»¿è‰²èŠ‚ç‚¹ï¼šæ•°æ®å­˜å‚¨ä¸æ£€ç´¢å¼•æ“ (å·²ä¸Šçº¿)<br>
            ğŸŸ  æ©™è‰²èŠ‚ç‚¹ï¼šå¼‚æ­¥ä»»åŠ¡å¤„ç† (Arq) (å·²ä¸Šçº¿)<br>
            âšª ç°è‰²è™šçº¿ï¼šPhase 3 è§„åˆ’ä¸­åŠŸèƒ½ (Webåå°ã€ç»Ÿè®¡ã€S3ã€Dockerç­‰)
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'base' });
    </script>
</body>
</html>
