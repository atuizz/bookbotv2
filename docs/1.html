<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æœä¹¦ç¥å™¨ V2 - æ¶æ„å…¨æ™¯å›¾ (ç»ˆæå…¼å®¹ç‰ˆ)</title>
    <!-- ä½¿ç”¨æœ€æ–°çš„ v11 ç‰ˆæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f6f8; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 1200px; margin: 0 auto; }
        h2 { border-bottom: 3px solid #0088cc; padding-bottom: 15px; color: #333; }
        .tips { background: #e3f2fd; padding: 10px; border-radius: 5px; color: #0d47a1; font-size: 0.9em; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>æœä¹¦ç¥å™¨ V2 - ç³»ç»Ÿé€»è¾‘æ¶æ„å›¾</h2>
        <div class="tips">ğŸ’¡ æç¤ºï¼šæ­¤å›¾å±•ç¤ºäº†ä»ç”¨æˆ·ä¸Šä¼ åˆ°å¤šé‡å¤‡ä»½çš„å®Œæ•´æ•°æ®æµå‘ã€‚</div>
        
        <div class="mermaid">
            flowchart TD
                %% èŠ‚ç‚¹å®šä¹‰ (ä½¿ç”¨å¼•å·åŒ…è£¹é˜²æ­¢è¯­æ³•é”™è¯¯)
                User(("ç”¨æˆ· (User)"))
                Admin(("ç®¡ç†å‘˜ (Admin)"))

                subgraph Core_Services ["æ ¸å¿ƒæœåŠ¡é›†ç¾¤"]
                    direction TB
                    TG_API["Telegram Bot API"]
                    Bot["Bot Core / Aiogram"]
                    Celery["Celery å¼‚æ­¥ Worker"]
                end

                subgraph Data_Layer ["æ•°æ®æŒä¹…å±‚"]
                    direction TB
                    Redis[("Redis ç¼“å­˜/é˜Ÿåˆ—")]
                    PG[("PostgreSQL æ•°æ®åº“")]
                    Meili[("Meilisearch æœç´¢å¼•æ“")]
                end

                subgraph Backup_System ["å¤‡ä»½ä¸å­˜å‚¨"]
                    direction TB
                    MainChannel["ä¸»é¢‘é“/ç¾¤ç»„"]
                    BackupChannel["ç§æœ‰å¤‡ä»½é¢‘é“"]
                    S3["S3 å¯¹è±¡å­˜å‚¨ (é¢„ç•™æ¥å£)"]
                end

                %% äº¤äº’è¿çº¿
                User -->|1.æœç´¢æŒ‡ä»¤ /s| TG_API
                User -->|2.ä¸Šä¼ æ–‡ä»¶| TG_API
                TG_API <-->|Webhook| Bot
                
                Admin -->|Web åå°| Bot
                Admin -->|/admin æŒ‡ä»¤| Bot

                %% å†…éƒ¨æ•°æ®æµ
                Bot -->|è¯»å†™| Redis
                Bot -->|å…¨æ–‡æ£€ç´¢| Meili
                Bot -->|å…ƒæ•°æ®| PG
                
                Bot -->|3.æ–‡ä»¶å…¥é˜Ÿ| Redis
                Redis -->|æ¶ˆè´¹ä»»åŠ¡| Celery

                %% Worker å¤„ç†æµ
                Celery -->|4.å»é‡ SHA256| PG
                Celery -->|5.æ··åˆæ‰“æ ‡| Meili
                Celery -->|6.è½¬å‘å¤‡ä»½| BackupChannel
                Celery -->|7.å®Œæˆé€šçŸ¥| User

                %% å¤‡ä»½æµ
                BackupChannel -.->|è®°å½• File_ID| PG
                BackupChannel -.->|å†·å¤‡ä»½| S3

                %% æ ·å¼å®šä¹‰
                classDef blue fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
                classDef green fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
                classDef orange fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;

                class Bot,TG_API blue;
                class PG,Meili,Redis green;
                class Celery orange;
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'base' });
    </script>
</body>
</html>